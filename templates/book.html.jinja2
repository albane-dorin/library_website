{% extends 'home.html.jinja2' %}

{% block link %}
    <title>BookHaven - {{ book.title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/book.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/common.css') }}">
    <script>
        function changeSave(user_id, book_id, s){
            const book = book_id
            const user = user_id
            console.log('heeere')
            fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: user, book_id: book, command: s })
            })
            .then(response => {
                if (response.ok) {
                    console.log("Data sent successfully.");
                    window.location.reload()

                } else {
                    console.error("Failed to send data.");
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }
    </script>
{% endblock %}

{% block main %}
    <a class="return" href="javascript:window.history.back();"><img src="{{ url_for('static', filename='/img/return.png') }}"> </a>
    <div class="content">
        <div style="justify-items: center">
            <img src="{{ book.img_path }}">
            {% if book.grade %}
            <p>{{ book.grade|round(2) }}/5</p>
           {% endif %}
        </div>
        <div class="main">
            <div class="book_top">
                <p class="book_title">{{ book.title }}</p>
                {% if user %}
                <div>
                <!-- <button> Mark as read </button> -->
                    {% if in_list %}
                        <button onclick="changeSave({{ user.id }}, {{ book.id }}, 'remove')" title="Remove from saved book" class="add_list"> <img src="{{ url_for('static', filename='img/remove-from-list.png') }}"> </button>
                    {% else %}
                        <button onclick="changeSave({{ user.id }}, {{ book.id }}, 'add')" title="Save book in list" class="add_list"> <img src="{{ url_for('static', filename='img/add-to-list.png') }}"></button>
                    {% endif %}
                    </div>
                {% endif %}
            </div>
            <p> {{ author.complete_name }}</p>
            {% if book.date!=None %}
            <p> Published {{ book.date.strftime("%B") }} {{ book.date.day }}, {{ book.date.year }}</p>
            {% else %}
            <p>Date not specified</p>
            {% endif %}
            {% if book.synopsis %}
                {% if book.synopsis|length > 500 %}
                <div>{{ book.synopsis[:500] }}...</div>
                {% else %}
                <div> {{ book.synopsis }}</div>
                {% endif %}
            {% else %}
                No synopsis
            {% endif %}
            <div class="book_genre"> Genres: {% for g in book.genres.split(';')[:-2] %} {{ g }} /  {% endfor %} {{ book.genres.split(';')[-2] }}</div>
        </div>
    </div>
    <div class="comments">
    <div class="page_title"> Comments:</div>

        {% if comments %}
            {% for c in comments %}
            <div class="comment">
                <div class="com_header">
                    <div>
                        Comment by
                        <span class="com_name"> {{ c[1].username }}  </span>
                        <span class="com_date">{{ "%02d" %c[0].date.day}}/{{ "%02d" %c[0].date.month }}/{{ c[0].date.year }} </span>:
                    </div>
                    {% if user and user.id==c[1].id %}
                        <button class="delete clickable" onclick="deleteConfirmation('open')"> Delete account </button>
                    {% endif %}
                </div>
                <div class="com_content">
                    {{ c[0].content }}
                </div>
            </div>
            {% endfor %}

        {% else %}
            <p> No comments yet</p>
        {% endif %}
    </div>

    <div id="pop-up">
        <p>Are you sure you want to delete your comment?</p>
        <div class="choice">
            <button class="choice_button" onclick="deleteConfirmation('close')"> Cancel </button>
            <button class="choice_button delete_button" onclick="deleteAccount({{ user.id }})"> Delete comment </button>
        </div>
    </div>
{% endblock %}